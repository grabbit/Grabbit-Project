<?
//$Id$
/**
 * Implementation of hook_menu()
 */
function grabbit_search_menu () {

  $items['grabbit/search/settings'] = array( 
    'page callback' => 'grabbit_search_ajustes', 
    'access arguments' => array('access content')
  );

  $items['grabbit/search'] = array( 
    'page callback' => 'drupal_get_form',
    'page arguments' => array('grabbit_search_form'), 
    'access arguments' => array('access content')
  );

  $items['grabbit/results'] = array( 
    'page callback' => 'grabbit_search_page',
    'page arguments' => $form_state['values']['search'], 
    'access arguments' => array('access content')
  );

  return $items;
}

function grabbit_search_ajustes(){
	global $user;
	
	$busqueda=$_GET['busqueda'];
	
	$result = db_query("SELECT node.nid AS nid
	 FROM node node 
	 INNER JOIN users users ON node.uid = users.uid
	 LEFT JOIN content_type_gmail node_data_field_from ON node.vid = node_data_field_from.vid
	 LEFT JOIN content_type_imap node_data_field_imap_from ON node.vid = node_data_field_imap_from.vid
	 LEFT JOIN content_type_facebook node_data_field_text ON node.vid = node_data_field_text.vid
	 LEFT JOIN node_revisions node_revisions ON node.vid = node_revisions.vid
	 WHERE (node.type in ('facebook', 'gmail', 'imap', 'twitter')) AND 
	 (users.uid in ('$user->uid')) 
	 AND (
		((node_data_field_from.field_from_value) LIKE ('%$busqueda%')) OR 
		((node_data_field_imap_from.field_imap_from_value) LIKE ('%$busqueda%')) OR
		((node_data_field_imap_from.field_imap_subject_value) LIKE ('%$busqueda%')) OR 
		((node_data_field_from.field_subject_value) LIKE ('%$busqueda%')) OR 
		((node_data_field_text.field_text_value) LIKE ('%$busqueda%')) OR 
		((node_data_field_text.field_comments_value) LIKE ('%$busqueda%')) OR 
		((node_revisions.body) LIKE ('%$busqueda%')) OR 
		((node.title) LIKE ('%$busqueda%')))
	");
	
	while($nid=db_fetch_object($result)){
		$node=node_load($nid->nid);
		print_r($node);
	}
	
}

function grabbit_search_perform($busqueda){
	global $user;
	
	$result = db_query("SELECT node.nid AS nid
	 FROM node node 
	 INNER JOIN users users ON node.uid = users.uid
	 LEFT JOIN content_type_gmail node_data_field_from ON node.vid = node_data_field_from.vid
	 LEFT JOIN content_type_imap node_data_field_imap_from ON node.vid = node_data_field_imap_from.vid
	 LEFT JOIN content_type_facebook node_data_field_text ON node.vid = node_data_field_text.vid
	 LEFT JOIN node_revisions node_revisions ON node.vid = node_revisions.vid
	 WHERE (node.type in ('facebook', 'gmail', 'imap', 'twitter')) AND 
	 (users.uid in ('$user->uid')) 
	 AND (
		((node_data_field_from.field_from_value) LIKE ('%$busqueda%')) OR 
		((node_data_field_imap_from.field_imap_from_value) LIKE ('%$busqueda%')) OR
		((node_data_field_imap_from.field_imap_subject_value) LIKE ('%$busqueda%')) OR 
		((node_data_field_from.field_subject_value) LIKE ('%$busqueda%')) OR 
		((node_data_field_text.field_text_value) LIKE ('%$busqueda%')) OR 
		((node_data_field_text.field_comments_value) LIKE ('%$busqueda%')) OR 
		((node_revisions.body) LIKE ('%$busqueda%')) OR 
		((node.title) LIKE ('%$busqueda%')))
	");
	
	if(db_affected_rows($result)){
		return $result;
	}else{
		return NULL;
	}
}

function grabbit_search_page($term=NULL){
	/*
	if($term){
		if($result =grabbit_search_perform($term)){
            $output = grabbit_search_results($results);
		}else{
			$output = grabbit_search_no_results($term);
		}
	}else{
		$output = drupal_get_form('grabbit_search_form');
	}
	*/
	print_r($term);
	$output='probano';
	return $output;
}

function grabbit_search_no_results($term){
	$output = drupal_get_form('grabbit_search_form');
	
	$output .='<div class="grabbit-search-empty">Your search did not match any results, please try again</div>';
	
	return $output;
}


function grabbit_search_results($results){
	$output = drupal_get_form('grabbit_search_form');
	
	$output .='<div class="grabbit-search-results"><span class="title"><h2>Search results:</h2></span>
	           ';
	
	
	$output .='</div>';
	
	return $output;
}

function grabbit_search_form(&$form_state){
 
	$form['counter'] = array(
	    '#type' => 'item',
	    '#prefix'=>'<div id="description">',
	    '#value' => t('You can perform a search of your grabbit stream, just type the keyword(s) below'),
	    '#suffix'=>'</div>'
		 );	 
	$form['search'] = array(
	    '#type' => 'textfield',
	    '#title' => t('Search'),
	    '#required' => TRUE,
	    '#size' => 20
	  );
	
	 $form['#action'] = url('grabbit/results');
	 $form['#redirect'] = FALSE;
	
	 $form['submit'] = array(
	    '#type' => 'submit',
	    '#value' => t('Save'),
	  ); 
	
	return $form;
}

 