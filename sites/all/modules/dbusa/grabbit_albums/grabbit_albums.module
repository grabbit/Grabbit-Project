<?

/**
 * Implementation of hook_menu()
 */
function grabbit_albums_menu() {

  $items['albums/calculate'] = array( 
    'page callback' => 'grabbit_albums_calculate', 
    'access arguments' => array('access content')
  );

  $items['albums/display'] = array( 
    'page callback' => 'grabbit_albums_display', 
    'title' => 'album',
    'access arguments' => array('access content')
  );

  return $items;
}

function grabbit_albums_preprocess_node(&$variables){
	if($variables['type']=='media'){
		global $user;
		drupal_add_js(drupal_get_path('module', 'grabbit_albums').'/albums_engine.js', $type = 'module');
		
		$controls = grabbit_aldums_calculate_next($variables['field_media_type'][0]['value'],$user,$variables['nid']);
		$variables['body']=$controls.$variables['body'];
	}
}

function grabbit_aldums_calculate_next($type,$user,$nid){
	
	switch($type){
		case "mov":
		case "mp3":
		case "flv":
		// media
		  $types = array("'mov'","'mp3'","'flv'");  
		  $album='media';
		break;
		case "doc":
		case "rtf":
		case "txt":
		case "csv":
		case "ppt":
		case "xls":
		case "pdf":
		// documents
		  $types = array("'doc'","'rtf'","'txt'","'csv'","'ppt'","'xls'","'pdf'");  
		  $album='documents';
		break;
		default:
		// photos
		  $types = array("'jpeg'", "'bmp'", "'jpg'", "'png'", "'gif'");
		  $album='images';
		break;
	}
	$sql_more="SELECT node.nid AS nid
	 FROM node node 
	 LEFT JOIN content_type_media node_data_field_media_type ON node.vid = node_data_field_media_type.vid
	 INNER JOIN users users ON node.uid = users.uid
	 WHERE (node.type in ('%s')) AND ((node_data_field_media_type.field_media_type_value) in (".implode($types,',').")) AND (users.uid in (%d)) AND (node.nid > %d) ORDER BY node.nid ASC LIMIT 1";
	
	$sql_less="SELECT node.nid AS nid
	 FROM node node 
	 LEFT JOIN content_type_media node_data_field_media_type ON node.vid = node_data_field_media_type.vid
	 INNER JOIN users users ON node.uid = users.uid
	 WHERE (node.type in ('%s')) AND ((node_data_field_media_type.field_media_type_value) in (".implode($types,',').")) AND (users.uid in (%d)) AND (node.nid < %d) ORDER BY node.nid DESC LIMIT 1";
	
	$more = db_result(db_query($sql_more,'media',$user->uid,$nid));
	
	$less = db_result(db_query($sql_less,'media',$user->uid,$nid));
	
	$controls = '<div class="album-control">';
	if($less)
	  $controls .=l('Previous','node/'.$less,array('attributes'=>array('class'=>'album-prev')));
	
	if($more)
	  $controls .=l('Next','node/'.$more,array('attributes'=>array('class'=>'album-next')));
	
	$controls .=l('album','album/'.$user->uid.'/'.$album);
	$controls .= '</div>';
	
	return $controls;
}

function grabbit_albums_display(){
	drupal_add_js(drupal_get_path('module', 'facebook_grabbit').'/facebook_grabbit.js', $type = 'module');
}

function grabbit_albums_calculate(){
	
}