<?

/*

	$blocks['content'] = '<div class="panels-update-form_file" style="display:none">
	             <div class="panels-update-wraper_file">
	             <form id="yfrog-form" action="#" method="post"> 
				    <input type="file" size="10" id="media" class="form-file" name="media"/>
				     
				    <input type="submit" value="Upload" /> 
				</form>
	             </div></div>';

*/

/**
 * Implementation of hook_menu()
 */
function grabbit_uploads_menu()
{
  $items['yfrog/upload'] = array( 
    'page callback' => 'grabbit_uploads_file_form_getit', 
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  );
  $items['uploads/credentials'] = array( 
    'page callback' => 'grabbit_uploads_save_data', 
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  ); 

  return $items;
}


class twitpic
{
  /* 
   * variable declarations
   */
  var $post_url='http://twitpic.com/api/upload';
  var $post_tweet_url='http://twitpic.com/api/uploadAndPost';
  var $url='';
  var $post_data='';
  var $result='';
  var $tweet='';
  var $return='';
 
/*
* @param1 is the array of data which is to be uploaded
* @param2 if passed true will display result in the XML format, default is false
* @param3 if passed true will update status twitter,default is false
*/
 
  function __construct($data,$return=false,$tweet=false)
  {
    $this->post_data=$data;
    if(empty($this->post_data) || !is_array($this->post_data)) //validates the data
      $this->throw_error(0);
    $this->display=$return;
    $this->tweet=$tweet;
 
  }
 
  function post()
  {
    $this->url=($this->tweet)?$this->post_tweet_url:$this->post_url; //assigns URL for curl request based on the nature of request by user
    $this->makeCurl();
  }
  private function makeCurl()
  {
    $curl = curl_init();
    curl_setopt($curl, CURLOPT_CONNECTTIMEOUT, 2);
    curl_setopt($curl, CURLOPT_HEADER, false);
    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($curl, CURLOPT_BINARYTRANSFER, 1);
    curl_setopt($curl, CURLOPT_URL, $this->url);
    curl_setopt($curl, CURLOPT_POST, 3);
    curl_setopt($curl, CURLOPT_POSTFIELDS, $this->post_data);
    $this->result = curl_exec($curl);
    curl_close($curl);
    if($this->display)
    {
      $this->result ;
    }
 
  }
  private function throw_error($code) //handles few errors, you can add more
 
  {
    switch($code)
    {
      case 0:
        echo 'Think, you forgot to pass the data';
        break;
      default:
        echo 'Something just broke !!';
        break;
    }
    exit;
  }
} //class ends here


function grabbit_uploads_file_form_getit(){
	
	  $file=$_FILES['media'];
	  $postfields = array();

	  $postfields['username'] = 'ivanfuyivara';
	  $postfields['password'] = "internet";
	  $postfields['media'] = "@$file[tmp_name]";

	  $t=new twitpic($postfields,true);
	  $t->post();
	  
	   $xml = new SimpleXMLElement($t->result);
	
       if(findAttribute($xml, 'stat')!='fail'){
	     print $xml->mediaurl;
       }else{
	     print findAttribute($xml->err, 'code');
       }

}

function findAttribute($object, $attribute) {
  foreach($object->attributes() as $a => $b) {
    if ($a == $attribute) {
      $return = $b;
    }
  }
  if($return) {
    return $return;
  }
}

function grabbit_uploads_save_data(){

  $user=$_POST['user'];
  $config['username']=$_POST['username'];
  $config['password']=$_POST['password'];
	
  $check = grabbit_uploads_get_uid($user);

  $savetodb = serialize($config);

  if(!$check){
    db_query("INSERT INTO {grabbit_uploads} (uid,config) VALUES (%d, '%s')",$user,$savetodb);	
    $result = '<form id="yfrog-form" action="#" method="post">
	                <input type="hidden" value="'.$user.'"/> 
				    <input type="file" size="10" id="media" class="form-file" name="media"/>	     
				    <input type="submit" value="Upload" /> 
				</form>';
  }
  else{
    db_query("UPDATE {grabbit_uploads} SET config='%s' WHERE uid=%d",$savetodb,$user);	
    $result = TRUE;
  }

  print $result;
  
}

function grabbit_uploads_get_uid($user){
	
  $result = db_query("SELECT * FROM {grabbit_uploads} WHERE uid = %d",$user);

  if ($user = db_fetch_object($result)) {
	$config = unserialize($user->config);
  }
  else{
    $config = FALSE;	
  }

  return $config;
}
